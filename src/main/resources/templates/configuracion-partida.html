<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{fragments/head :: header}" />
    <title>Arena of Music</title>
</head>

<body class="d-flex flex-column h-100">
    <header th:replace="~{fragments/nav.html :: nav}"></header>
    <main class="flex-shrink-0">
        <div class="container mt-5">
            <div class="card border-2 p-4">
                <h2 class="text-center">Configurar Partida</h2>
                <form method="POST" action="/partida/crear-partida" id="formCrearPartida">
                    <!-- Selección de Playlist -->
                    <div class="mb-3">
                        <label for="playlist" class="form-label">Selecciona una Playlist</label>
                        <select class="form-select" id="playlist" name="playlistId" required>
                            <option value="" disabled selected>Elige una Playlist...</option> <!-- Placeholder -->
                            <option th:each="playlist : ${playlists}" th:value="${playlist.id}"
                                th:text="${playlist.name}"></option>
                        </select>
                    </div>

                    <!-- Número de Rondas -->
                    <div class="mb-3">
                        <label for="rondas" class="form-label">Número de Rondas: <span id="rondasValue"
                                class="range-value">5</span></label>
                        <input type="range" class="form-range" id="rondas" min="5" max="25" value="5" step="1"
                            name="rondas">
                    </div>

                    <!-- Tiempo de Fragmento -->
                    <div class="mb-3">
                        <label for="tiempo" class="form-label">Duración del Fragmento: <span id="tiempoValue"
                                class="range-value">5</span> segundos</label>
                        <input type="range" class="form-range" id="tiempo" min="5" max="30" value="5" step="1"
                            name="tiempo">
                    </div>

                    <!-- Modo de Juego -->
                    <div class="mb-3">
                        <label class="form-label">Modo de Juego</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="modoJuego" id="escribir" value="escribir"
                                checked>
                            <label class="form-check-label" for="escribir">Escribir la Canción</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="modoJuego" id="opciones" value="opciones"
                                disabled>
                            <label class="form-check-label" for="opciones">Opciones <small
                                    class="text-muted">(Próximamente...)</small></label>
                        </div>
                    </div>

                    <!-- Botón de Envío -->
                    <div class="text-center">
                        <button type="submit" id="btn-guardar-configuracion" class="btn btn-primary w-100">Iniciar
                            Partida</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    <script>
        // Mostrar valores dinámicamente
        const rondasInput = document.getElementById("rondas");
        const rondasValue = document.getElementById("rondasValue");
        rondasInput.addEventListener("input", () => rondasValue.textContent = rondasInput.value);

        const tiempoInput = document.getElementById("tiempo");
        const tiempoValue = document.getElementById("tiempoValue");
        tiempoInput.addEventListener("input", () => tiempoValue.textContent = tiempoInput.value);
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById('formCrearPartida');

            // Validación y envío del formulario por AJAX
            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Evita el envío tradicional del formulario

                // Obtenemos los valores del formulario
                const playlistId = document.getElementById('playlist').value;  // Corregido aquí
                const rondas = document.getElementById('rondas').value;
                const tiempo = document.getElementById('tiempo').value;
                const modoJuego = document.querySelector('input[name="modoJuego"]:checked').value;

                // Comprobación de que todos los campos tienen datos válidos
                if (!playlistId || !rondas || !tiempo || !modoJuego) {
                    alert('Por favor, complete todos los campos del formulario.');
                    return;
                }

                if (isNaN(rondas) || isNaN(tiempo) || rondas <= 0 || tiempo <= 0) {
                    alert('Las rondas y el tiempo deben ser números positivos.');
                    return;
                }

                // Obtener el token CSRF directamente del formulario
                const csrfToken = document.querySelector('input[name="_csrf"]').value;

                // Realizamos la petición AJAX
                const formData = new URLSearchParams();
                formData.append('playlistId', playlistId);
                formData.append('rondas', rondas);
                formData.append('tiempo', tiempo);
                formData.append('modoJuego', modoJuego);

                fetch('/partida/crear-partida', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRF-TOKEN': csrfToken // Usamos el token CSRF aquí
                    },
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        return response.json().then(error => { throw new Error(error.message || 'Error en la solicitud'); });
                    }
                    // Redirigir a sala de espera(ToDo: recuperar id de partida y redirigir a sala de espera de esa partida) 
                    window.location.href = '/partida/sala-espera'; 
                }).catch(error => {
                    //Errores
                    console.error('Error al crear la partida:', error);
                    alert('Hubo un error al crear la partida. Intenta nuevamente.');
                });
            });
        });
    </script>

    <th:block th:replace="~{fragments/footer.html :: footer}" />
</body>

</html>